<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–°–∫–∞–Ω–µ—Ä —É—á–∞—Å—Ç–Ω–∏–∫–∞</title>

<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: system-ui, sans-serif;
    background: #f5f5f5;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  h2 {
    text-align: center;
    margin-top: 20px;
    font-size: 20px;
  }

  #reader {
    width: 100%;
    max-width: 480px;
    height: auto;
    aspect-ratio: 1;
    background: black;
    margin: 20px auto;
    box-shadow: 0 0 12px rgba(0,0,0,0.15);
    border-radius: 12px;
  }

  #reader video {
    width: 100% !important;
    height: auto !important;
    object-fit: cover;
    border-radius: 12px;
  }

  #camera-select {
    margin: 10px auto;
    font-size: 14px;
    padding: 6px 10px;
    border-radius: 8px;
  }

  #result {
    background: #fff;
    padding: 15px;
    margin: 10px auto;
    border-radius: 10px;
    box-shadow: 0 0 6px rgba(0,0,0,0.1);
    max-width: 320px;
    text-align: left;
  }

  #result strong {
    color: #006400;
  }
</style>

  <!-- üì¶ –°—é–¥–∞ –º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å html5-qrcode -->
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>

  <!-- ‚úÖ –°—é–¥–∞ –≤—Å—Ç–∞–≤–ª—è–µ–º HTML-–∫–æ–Ω—Ç–µ–Ω—Ç -->
  <h2>üì∑ –°–∫–∞–Ω–µ—Ä —É—á–∞—Å—Ç–Ω–∏–∫–∞</h2>
<div id="reader"></div>
<select id="camera-select"></select>
<div id="result">
  <p class="name">‚úî –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω</p>
  <p>üìÖ –î–∞—Ç–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è: <strong>01/09/2024</strong></p>
</div>

  <!-- ‚úÖ –í–Ω–∏–∑—É ‚Äî JavaScript –¥–ª—è –ª–æ–≥–∏–∫–∏ -->
  <script>
  const resultBox = document.getElementById('result');
  const fullNameSpan = document.getElementById('fullName');
  const joinDateSpan = document.getElementById('joinDate');
  const cameraSelect = document.getElementById('cameraSelect');
  const html5QrCode = new Html5Qrcode("reader");

  function onScanSuccess(decodedText) {
    const url = `https://qr-id-system.onrender.com/lookup?id=${decodedText}`;
    fetch(url)
      .then(res => res.json())
      .then(data => {
        fullNameSpan.textContent = data.name;
        joinDateSpan.textContent = data.join_date;
        resultBox.style.display = 'block';
      })
      .catch(err => {
        fullNameSpan.textContent = '‚ùå –£—á–∞—Å—Ç–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω';
        joinDateSpan.textContent = '';
        resultBox.style.display = 'block';
      });
  }

  Html5Qrcode.getCameras().then(devices => {
    if (devices && devices.length) {
      // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä
      devices.forEach((device, index) => {
        const option = document.createElement("option");
        option.value = device.id;
        option.text = device.label || `–ö–∞–º–µ—Ä–∞ ${index + 1}`;
        cameraSelect.appendChild(option);
      });

      let backCamera = devices.find(d => d.label.toLowerCase().includes("back")) || devices[0];
      cameraSelect.value = backCamera.id;

      // –ó–∞–ø—É—Å–∫ —Å –∑–∞–¥–Ω–µ–π –∫–∞–º–µ—Ä—ã
      html5QrCode.start(
        { deviceId: { exact: backCamera.id } },
        {
          fps: 10,
          qrbox: { width: 250, height: 250 },
          aspectRatio: 1.0
        },
        onScanSuccess
      );

      cameraSelect.addEventListener('change', () => {
        html5QrCode.stop().then(() => {
          html5QrCode.start(
            { deviceId: { exact: cameraSelect.value } },
            {
              fps: 10,
              qrbox: { width: 250, height: 250 },
              aspectRatio: 1.0
            },
            onScanSuccess
          );
        });
      });
    } else {
      alert("–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
    }
  }).catch(err => {
    console.error("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ", err);
    alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: " + err.message);
  });
</script>
</body>
</html>
