<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–°–∫–∞–Ω–µ—Ä —É—á–∞—Å—Ç–Ω–∏–∫–∞</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      text-align: center;
      margin: 0;
      padding: 20px;
    }
    h2 {
      margin-bottom: 20px;
    }
    #reader {
      width: 100%;
      max-width: 280px;
      aspect-ratio: 1;
      margin: auto;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      background: black;
    }
    #result {
      margin-top: 20px;
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 15px;
      display: none;
      max-width: 320px;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    select {
      padding: 8px 14px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <h2>üì∑ –°–∫–∞–Ω–µ—Ä —É—á–∞—Å—Ç–Ω–∏–∫–∞</h2>
  <div id="reader"></div>

  <div>
    <label for="cameraSelect">üì∑ –í—ã–±–æ—Ä –∫–∞–º–µ—Ä—ã:</label>
    <select id="cameraSelect"></select>
  </div>

  <div id="result">
    <p>‚úÖ <strong id="fullName"></strong></p>
    <p>üìÖ –î–∞—Ç–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è: <strong id="joinDate"></strong></p>
  </div>

  <script>
    const resultBox = document.getElementById('result');
    const fullNameSpan = document.getElementById('fullName');
    const joinDateSpan = document.getElementById('joinDate');
    const html5QrCode = new Html5Qrcode("reader");
    const cameraSelect = document.getElementById("cameraSelect");

    function onScanSuccess(decodedText) {
      const url = `https://qr-id-system.onrender.com/lookup?id=${decodedText}`;
      fetch(url)
        .then(res => res.json())
        .then(data => {
          fullNameSpan.textContent = data.name;
          joinDateSpan.textContent = data.join_date;
          resultBox.style.display = 'block';
        })
        .catch(err => {
          fullNameSpan.textContent = '‚ùå –£—á–∞—Å—Ç–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω';
          joinDateSpan.textContent = '';
          resultBox.style.display = 'block';
        });
    }

    Html5Qrcode.getCameras().then(devices => {
      if (devices && devices.length) {
        devices.forEach((device, index) => {
          const option = document.createElement("option");
          option.value = device.id;
          option.text = device.label || `–ö–∞–º–µ—Ä–∞ ${index + 1}`;
          cameraSelect.appendChild(option);
        });

        // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∑–∞–¥–Ω–µ–π –∫–∞–º–µ—Ä—ã
        const backCam = devices.find(d => d.label.toLowerCase().includes("back")) || devices[0];
        cameraSelect.value = backCam.id;

        html5QrCode.start({ deviceId: { exact: backCam.id } }, {
          fps: 10,
          qrbox: { width: 250, height: 250 },
          aspectRatio: 1
        }, onScanSuccess);

        cameraSelect.addEventListener('change', () => {
          html5QrCode.stop().then(() => {
            html5QrCode.start({ deviceId: { exact: cameraSelect.value } }, {
              fps: 10,
              qrbox: { width: 250, height: 250 },
              aspectRatio: 1
            }, onScanSuccess);
          });
        });
      }
    }).catch(err => {
      alert("–ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å –∫–∞–º–µ—Ä—É: " + err);
    });
  </script>
</body>
</html>
